(function(e){if(typeof(e.pageflow)=="undefined"){e.pageflow=function(g,f){return new e.pageflow.fn.construct(g,f);};var a=e.Template('<li id="guide_{name}" title="{desc}" name="guide_{name}"  stepname={name}  class="{class}" style="{style}"><a href="javascript:void(0);" stepname="{name}"  onclick="">{desc}</a></li>');
var d=e.ctx.attr("page");var c="submit";var b='<div class="c_toolTip c_toolTip-bottom" id="pageflow_restart_toolTip" style="height:75px;left:30px;top:auto;display:none;visibility:;">'+'<div class="c_toolTipTop"><div></div></div>'+'<div class="c_toolTipContent">'+e.lang["view.web.comp.pageflow.deltip"]+'	<div class="c_toolTipDelete">'+'		<a href="#nogo" id="pageflow_restart__toolTip_delete">'+e.lang["view.web.comp.pageflow.noshow"]+"</a>"+"	</div>"+"</div>"+'<div class="c_toolTipBottom"><div></div></div>'+'<div class="c_toolTipPointer" id="pageflow_restart_tipPointer" style="right:auto; left:30px;"></div>'+'<!--[if IE 6]><iframe class="c_toolTipCover"></iframe><![endif]-->'+"</div>";
e.pageflow.fn={construct:function(g,f){this.id=g;this.steps=f;this.imgstatus=0;this.active=0;this.activeFrames=[];this.curStep="";this.size=f.length;this.gostep=e.DataMap("{}");this.drawGuide=false;this.isFilish=false;e.extend(this,f);},getName:function(){return this.id;},execExpress:function(i,k,h){var j=this.getStepFrame(i);
if(j){var g=j("#"+k).val();if(g==null||typeof(g)=="undefined"){return h;}return g;}return h;},getTransData:function(k){var m=this.getStep(k);if(m==null||typeof(m)=="undefined"){return null;}if(m["name"]=="begin"||m["name"]=="end"||m["tagname"]!="step"){return null;}var l=this.getStepFrame(m["name"]);
if(l){var i=m["transdata"];if(i&&typeof(i)!="undefined"){var h=[];var j=l;var g=window.getFlow();e.each(i.split(","),function(f,r){if(r.indexOf("@")>0){var q=r.split("@");l=g.getStepFrame(q[0]);r=q[1];}else{l=j;}var p=e.trim(r);var n=l("#"+p);if(n.length&&(n.isNodeName("input")||n.isNodeName("textarea")||n.isNodeName("select"))){h.push(p+"="+encodeURIComponent(n.val()===undefined?"":n.val()));
}else{if(n.length>0){var o=l.ajax.buildPostData(p);if(o!=""){h.push(o);}else{h.push(p+"={}");}}else{h.push(p+"={}");}}h.join("&");});return h.join("&");}}return null;},isMonChanged:function(j){var i=this.getStep(j);if(i==null&&typeof(i)=="undefined"){return false;}var g=e("#guide_"+i["name"]);var f=g.attr("monitor");
if(!f||f==""){return false;}var h="{"+this.getStepMonitor(j)+"}";return f!=h;},getStepMonitor:function(i){var k=this.getStep(i);if(k==null&&typeof(k)=="undefined"){return null;}var g=k["monitor"];var h=[];if(g){var j=this.getStepFrame(i);if(j){e.each(g.split(","),function(f,n){var l=j("#"+e.trim(n));
if(l.length>0){if(l.val()){h.push(e.trim(n)+"="+l.val());}else{var m=j.ajax.buildPostData(e.trim(n));h.push(m);}}});g=null;return h;}}g=null;return null;},setMonitor:function(g){var i=this.getStep(this.active);if(i==null&&typeof(i)=="undefined"){return null;}var h=this.getStepMonitor(this.active);if(h!=null){var f=e("#guide_"+i["name"]);
if(g==true){f.attr("monitor","{"+h+"}");}else{f.attr("monitor","");}}},setGuide:function(k,f){var g=e("#flowguide");if(this.drawGuide==false){g.html("");this.drawGuide=true;}else{var i=this.getStep(k);if(i==null||typeof(i)=="undefined"){return;}if(i["name"]==="begin"||i["name"]==="end"){return;}if(k==this.active){return;
}var l=this.gostep;var m=this.active;var h=this.firstStep();var j=this.lastStep();var n=true;e.each(e("li[id^=guide_]",g[0]),function(o,r){var q=e(r);var p=q.attr("stepname");if(p!="begin"&&p!="end"){if(l.get(p)){if(p==i["name"]){if(f!=false){e("#guide_"+m).remove();}if(h&&h==p){q.attr("class","first on");
}else{q.attr("class","on");}n=false;}else{if(h&&h==p){q.attr("class","first ok");}else{q.attr("class","ok");}}}}});if(l.get(m)&&n){if(h&&h==k){a.append(g,{"name":i["name"],"desc":i["desc"],"class":"first on"});}else{if(j&&j.indexOf(k+"|")>-1){a.append(g,{"name":i["name"],"desc":i["desc"],"class":"last on"});
}else{a.append(g,{"name":i["name"],"desc":i["desc"],"class":"on"});}}e("#guide_"+k).bind("click",function(){window.getFlow().backView(this.id.split("_")[1]);});}}},firstStep:function(){var f;e.each(this.steps,function(g,h){if(h["tagname"]=="step"){if(h["name"]==="begin"){f=h["nextstep"];}}});return f;
},lastStep:function(){var f;e.each(this.steps,function(g,h){if(h["tagname"]=="step"){if(h["nextstep"]==="end"){f+=h["name"]+"|";}}});return f;},backView:function(g){if(g==null||typeof(g)=="undefined"){return;}var f=this.getChange();if(f==g){return;}if(f){e("#guide_"+f).attr("monitor","{"+this.getStepMonitor(f)+"}");
if(window.confirm(e.lang["view.web.comp.pageflow.confirm"])){this.reset(f);this.setShowPage(f);e("#bnext").triggerHandler("click");return;}}this.setShowPage(g);this.resetByGuide(g,false);this.setAutoHeight();this.curStep=g;},reset:function(h,k){if(!h){return;}var m=this.activeFrames.slice(this.activeFrames.length-1)[0];
if(h!=m){var l=e("#bback").attr("back");this.resetStatus(h,k);var g=this.gostep.indexOfKey(h);var j=this.gostep.getCount();for(var f=j-1;f>g;f--){e("#guide_"+this.gostep.itemAt(f)["name"]).remove();this.gostep.removeAt(f);}}},resetByGuide:function(f,g){if(!f){return;}if(f!=this.active){this.resetStatus(f,g);
}},resetStatus:function(k,h){var m=this.getStep(k);if(m==null||typeof(m)=="undefined"){return;}if(m["name"]==="begin"||m["name"]==="end"){return;}m["nexttrigger"]="";this.setGuide(k,h);this.setFlow(k);if(h!=false){var g;var l=e.inArray(k,this.activeFrames);var j;if(l>=0){j=this.activeFrames.length-l-1;
}else{j=this.activeFrames.length;}for(var f=0;f<j;f++){g=this.activeFrames.pop();e("#"+g).attr("src","about:blank");}this.setButton(k);this.active=k;this.curStep=k;}},getChange:function(){var f=null;this.gostep.eachKey(function(h,g){if(window.getFlow().isMonChanged(h)){f=h;return true;}});return f;},setShowPage:function(h){var j=this.firstStep();
var f=this.lastStep();var i=this.active;var g=this.autoSize();this.setFlow(h);e.each(this.steps,function(){if(this["tagname"]=="step"){if(this["name"]==h){if(j&&j==h){e("#guide_"+h).attr("class","first on");}else{if(f&&f.indexOf(h+"|")>-1){e("#guide_"+h).attr("class","last on");}else{e("#guide_"+h).attr("class","on");
}}e("#"+this["name"]).attr("height",g);e("#"+this["name"]).css("display","block");}else{if(this["name"]==i){if(f&&f.indexOf(i+"|")>-1){e("#guide_"+i).attr("class","last active");}else{e("#guide_"+i).attr("class","active");}}else{if(j&&j==this["name"]){e("#guide_"+this["name"]).attr("class","first ok");
}else{e("#guide_"+this["name"]).attr("class","ok");}}e("#"+this["name"]).css("display","none");e("#"+this["name"]).attr("height","0");}}});},setFrame:function(i,f){var l=window["Wade_isStopResizeHeight"];window["Wade_isStopResizeHeight"]=true;var g=this.getStep(i);if(g==null||typeof(g)=="undefined"){return;
}var o=this.getTransData(this.active);var m=this.autoSize();var n=this.isMonChanged(this.active);var h=this.activeFrames;if(this.getStep("begin")["nextstep"]==i){var k=window.location.search;if(k){if(k.indexOf("?service=")==0){var j=k.indexOf("&");if(j>-1){k=k.substring(j+1);}}if(k.indexOf("&")==0){f+=k;
}else{if(k.indexOf("?")==0&&k.length>1){f+="&"+k.substring(1);}else{f+="&"+k;}}}}e.each(this.steps,function(r){if(this["name"]==r){if(e("#"+this["name"]).attr("src")=="about:blank"||n==true){var p=this["name"];e("#"+p).bind("load",function(s){window["Wade_isStopResizeHeight"]=l;});if(e.inArray(p,h)==-1){h.push(p);
}if(o){e("#"+p).attr("src",e.redirect.buildUrl(this["page"],this["listener"],"&"+o+f));}else{e("#"+p).attr("src",e.redirect.buildUrl(this["page"],this["listener"],f));}o=null;e("#"+p).bind("load",function(){e.disabledButton("bnext",false);window.getFlow().setAutoHeight();var s=e("#"+p)[0].contentWindow;
if(s&&s.$&&(s.$.redirect.getPageName()=="Exception")){window.getFlow().setButton(r,true);}e(s).bind("resize",function(){window.getFlow().setAutoHeight();});});}else{window["Wade_isStopResizeHeight"]=l;var p=this["name"];var q=e("#"+p)[0].contentWindow;if(q&&q.$&&(q.$.redirect.getPageName()=="Exception")){window.getFlow().setButton(r,true);
}}e("#"+this["name"]).attr("height",m);e("#"+this["name"]).css("display","");}else{e("#"+this["name"]).attr("height","0");e("#"+this["name"]).css("display","none");}},[g["name"]]);},setFlow:function(h){var i=this.getStep(h);if(i==null||typeof(i)=="undefined"){return;}var g=e("#flow");if(g.length>0){var f=this.gostep;
e.each(e("a[id^=flow_]",g[0]),function(j,l){var m=e(l);var k=m.attr("name").substring(5);if(f.get(k)){if(k==i["name"]){m.attr("class","step on");}else{m.attr("class","step ok");}}else{if(m.attr("class")!="judge"&&m.attr("class")!="start"&&m.attr("class")!="end"){m.attr("class","step");}}});}},setButton:function(i,f){var j=this.getStep(i);
if(j==null||typeof(j)=="undefined"){return;}if(f){e("#bnext").attr("disabled","disabled");}if(j["nextstep"]=="end"){e("#bnext").attr("class","finish");e("#bnext").attr("active",i);e("#bnext").attr("uuid",i);e("#bnext").html(e.lang.get("pageflow.button.bfinish"));e("#bnext").attr("next",j["nextstep"]);
e("#bnext").unbind("click");e("#bnext").bind("click",function(){window.getFlow().submit();});this.isFilish=true;}else{e("#bnext").attr("class","");e("#bnext").attr("active",i);e("#bnext").attr("uuid","step");e("#bnext").attr("next",j["nextstep"]);e("#bnext").html(e.lang.get("pageflow.button.bnext"));
e("#bnext").unbind("click");e("#bnext").bind("click",function(){window.getFlow().next(j["nextstep"]);});this.isFilish=false;}if(f){e.disabledButton("bnext",true);}else{e.disabledButton("bnext",false);}var h=this.getStep("begin")["nextstep"];if(h!=i){e("#bback").css("visibility","visible");var g=null;
this.gostep.eachKey(function(l,k){if(l==j["name"]){return;}g=l;});e("#bback").attr("active",i);e("#bback").attr("back",g);e("#bback").unbind("click");e("#bback").bind("click",function(){window.getFlow().back(g);});}else{e("#bback").css("visibility","hidden");e("#bback").unbind("click");}},toSwitch:function(m,g,n){var i=this.getStep(m);
if(i==null||typeof(i)=="undefined"){return;}var l=this.getActive();var f=this.execExpress(l["name"],i["expression"],i["default"]);l=null;var h=null;e.each(i["cases"],function(o){if(this["value"]==o){h=o;return true;}},[f]);var j=null;try{if(h==null){j=i["cases"][i["default"]]["nextstep"];}else{j=i["cases"][h]["nextstep"];
}}catch(k){alert("bad switch config,at "+m);return -1;}if(j==null||typeof(j)=="undefined"){alert("bad switch config,at "+m);return -1;}this.next(j,g,n);},getActive:function(){var f=this.getStep(this.active);if(f==null||typeof(f)=="undefined"){alert("the flow has stopped");return null;}return f;},getStep:function(g){if(g&&typeof(g)=="string"){var f=null;
e.each(this.steps,function(h){if(this["name"]==h){f=this;return true;}},[g]);return f;}else{return this.steps[g];}},getStepFrame:function(f){return e("#"+f)[0].contentWindow.window.Wade;},showImage:function(){e("div[class*=c_flow]").css("display",this.imgstatus==0?"":"none");this.imgstatus=(this.imgstatus==0?1:0);
this.setAutoHeight();},autoSize:function(){return document.body.offsetHeight-e("div[class=c_guideStep]")[0].offsetHeight-e("div[class=c_flow]")[0].offsetHeight-e("div[class=c_guideSubmit]")[0].offsetHeight;},setAutoHeight:function(){var f=this.autoSize();e.each(this.steps,function(g,j){var h=j["name"];
if(h!="begin"||h!="end"){var i=e("#"+h);if(i.length>0&&i.attr("src")&&i.attr("src")!=""&&i.attr("height")&&i.attr("height")!="0"){i.css("height",f);}}});},getBackStep:function(){return this.getStep(e("#bback").attr("back"));},getSubmitData:function(){var g="";var f=window.getFlow();this.gostep.eachKey(function(j,h){var l=f.getStep(j);
var m=f.getStepFrame(j);if(m){var i=l["submitdata"];if(i){var n,k;e.each(i.split(","),function(o,p){n=e.trim(p);k=m("#"+n);if(k.length&&(k.isNodeName("input")||k.isNodeName("textarea")||k.isNodeName("select"))){g+="&"+n+"="+k.val();}else{g+="&"+m.ajax.buildPostData(n);}});}}});return g;},cleanup:function(){e("#flowguide").html("");
a.append(e("#flowguide"),{"name":"begin","index":"0","desc":"开始"});e.each(this.steps,function(f,g){e("#"+g["name"]).attr("src","");});this.id=null;this.steps=null;this.imgstatus=null;this.gostep=null;},initFlow:function(){var f=this.getStep("begin");if(f==null||typeof(f)=="undefined"){return;}e.each(this.steps,function(){e("#"+this["name"]).attr("src","about:blank");
});if(e("#restart")&&e("#restart").length>0){e.appendContextMenu(e("#restart"),null,b,200,"pageflow_restart_toolTip");this.setRestartButton();}this.gostep.put(f["name"],f);this.active=f["name"];this.curStep=f["name"];this.setGuide(0);this.next(f["nextstep"]);this.setMonitor(true);},setRestartButton:function(){e("#restart").bind("click",function(){e("#pageflow_restart_toolTip").css("display","none");
window.getFlow().cleanup();window.location.reload(true);});e("#pageflow_restart__toolTip_delete").bind("click",function(){e("#restart").unbind("mouseover");e("#restart").unbind("mouseout");e("#pageflow_restart_toolTip").css("display","none");});e("#pageflow_restart_toolTip").bind("mouseover",function(){window["pageFlow_toolTip_mouseover"]=true;
});e("#pageflow_restart_toolTip").bind("mouseout",function(){window["pageFlow_toolTip_mouseover"]=false;var f=setTimeout(function(){if(!window["pageFlow_toolTip_mouseover"]&&!window["pageFlow_restart_mouseover"]){e("#pageflow_restart_toolTip").css("display","none");}if(f){clearTimeout(f);}},100);});e("#restart").bind("mouseover",function(){if(window["pageFlow_restart_mouseover"]==true){return;
}window["pageFlow_restart_mouseover"]=true;var f=window.getFlow().autoSize();var g=e.initPosition(e("#restart"),200,"pageflow_restart_toolTip",null,null,f);e("#pageflow_restart_toolTip").css("top",g.topPx+"px");e("#pageflow_restart_toolTip").css("left",g.leftPx+"px");e("#pageflow_restart_tipPointer").css("left",g.leftPx+"px");
e("#pageflow_restart_toolTip").css("display","block");});e("#restart").bind("mouseout",function(){window["pageFlow_restart_mouseover"]=false;var f=setTimeout(function(){if(!window["pageFlow_toolTip_mouseover"]&&!window["pageFlow_restart_mouseover"]){e("#pageflow_restart_toolTip").css("display","none");
}if(f){clearTimeout(f);}},100);});},next:function(m,h,o){if(!m){m=e("#bnext").attr("next");}var g=this.getActive();var i="";if(o!=true){var l=this.getStepFrame(this.active);if(l!=null){var q=l("#"+g["nextbutton"]);if(q.length>0){if(g["nexttrigger"]!="true"){if(this.stepChange(h)===false){return;}var n=q.triggerHandler("click");
var p=q.attr("donext");if(n==false||(p&&p=="false")){return;}else{g["nexttrigger"]="true";}}var k=q.attr("nextparams");if(k){i="&"+k;}k=null;}}l==null;}if(this.stepChange(h)===false){return;}this.setShowPage(this.active);var j=this.getStep(m);if(j==null||typeof(j)=="undefined"){return;}if(j["subflow"]=="page"){if(j["hasOpen"]!=true){if(window["openNav"]){window.openNav(j["desc"],j["page"],j["listener"],i,j["subsys"]);
}j["hasOpen"]=true;return;}else{j=this.getStep(j["nextstep"]);m=j["name"];}}if(j["tagname"]=="switch"){this.toSwitch(m,h,o);return;}this.gostep.put(j["name"],j);this.setGuide(m,false);this.setFlow(m);if(e("#"+j["name"]).attr("src")!="about:blank"){this.setButton(m);}else{this.setButton(m,true);}this.setFrame(m,i);
this.setMonitor(true);this.active=m;this.curStep=m;this.setAutoHeight();},back:function(h,g){if(!h){h=e("#bback").attr("back");}var l=this.getStep(h);if(l==null||typeof(l)=="undefined"){return;}if(l["name"]==="begin"||l["name"]==="end"){return;}var m=this.getActive();if(g!=true){var k=this.getStepFrame(this.active);
if(k!=null){var j=k("#"+m["backbutton"]);if(j.length>0){var i=j.triggerHandler("click");if(i==false){return;}}}k==null;}l["nexttrigger"]="";this.gostep.removeKey(this.active);this.setGuide(h);this.setFlow(h);this.setButton(h);this.setMonitor(false);this.setFrame(h,"");this.active=h;this.curStep=h;this.setAutoHeight();
},cancel:function(){alert("close the window!");},submit:function(){e.disabledButton("bnext",true);var k=this.getActive();var j=this.getStepFrame(k["name"]);if(j!=null){var l=j("#"+k["nextbutton"]);if(l.length>0){if(this.stepChange()===false){return;}var g=l.triggerHandler("click");if(!g){e.disabledButton("bnext",false);
return;}}}j=null;if(this.stepChange()===false){return;}var i="";var h=window.getFlow();this.gostep.eachKey(function(n,f){var o=h.getStep(n);var p=h.getStepFrame(n);if(p){var m=o["submitdata"];if(m){e.each(m.split(","),function(q,s){if(p("#"+e.trim(s)).val()){i+="&"+s+"="+p("#"+e.trim(s)).val();}else{var r=p.ajax.buildPostData(e.trim(s));
i+="&"+r;}});}}});if(e.isFunction(window.flowSubmit)){window.flowSubmit();}else{e.ajax.post(d,c,i,null,function(f){e.disabledButton("bnext",false);alert(e.lang["view.web.comp.pageflow.submit"]);window.getFlow().cleanup();window.location.reload(true);},function(f,m){e.disabledButton("bnext",false);alert(m);
},function(){e.disabledButton("bnext",false);alert(e.lang["view.web.comp.pageflow.busy"]);});}},stepChange:function(h){var f=this.getChange();var g=this.activeFrames.slice(this.activeFrames.length-1)[0];if(h!=true){if(f&&f!=g){e("#guide_"+f).attr("monitor","{"+this.getStepMonitor(f)+"}");if(window.confirm(e.lang["view.web.comp.pageflow.confirm"])){this.reset(f);
this.setShowPage(f);e("#bnext").triggerHandler("click");return false;}}}else{if(f&&f!=g&&f==this.curStep){e("#guide_"+this.curStep).attr("monitor","{"+this.getStepMonitor(this.curStep)+"}");}}return true;},isFilishStep:function(){return this.isFilish;}};e.pageflow.fn.construct.prototype=e.pageflow.fn;
}})(Wade);