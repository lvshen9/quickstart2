var fileTableTemp=$.Template("<tr id={id} index={index}>"+'<td id="{id}Value">{status}</td>'+'<td class="wrap"><i class="e_ico-{filetype}"></i>{name}</td>'+'<td class="e_left" id="{id}Size">{size}</td>'+'<td class="e_center">'+'<span id="{id}Progress" class="e_progress {progress}">'+'<span id="{id}Percent1" class="e_progressBar" style="width:{percent}%;"></span>'+'<span id="{id}Percent2" class="e_progressValue">{percent}%</span>'+"</span>"+"</td>"+'<td class="fn e_center"><a href="javascript:void(0);" id="{id}Delete" onclick="deleteFileFromTable(\'{id}\')">{oper}</a></td>'+"</tr>");
var swfu;SWFUpload.onload=function(){var a={flash_url:"component/upload/swfupload.swf",flash9_url:"component/upload/swfupload_fp9.swf",upload_url:"attach?action=upload&random="+Math.random()+"&ftpSite="+$("#ftpSite").val()+"&filePath="+$("#filePath").val(),file_size_limit:$("#fileSize").val()+" MB",file_types:$("#fileTypes").val(),file_types_description:$("#fileTypesDesc").val(),file_upload_limit:parseInt($("#fileLimit").val()),file_queue_limit:0,button_placeholder_id:"bupload",button_width:84,button_height:23,button_image_url:"ecl/base/button-upload"+$.lang["view.web.comp.upload.image"]+".png",custom_settings:{file_delete_ids:"file_delete_ids",file_field_id:$("#uploadField").val(),file_upload_data:$("#fileData").val(),file_urlpath:$("#urlpath").val().substring(0,$("#urlpath").val().lastIndexOf("/"))},button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,button_cursor:SWFUpload.CURSOR.HAND,swfupload_loaded_handler:swfUploadLoaded,file_dialog_start_handler:fileDialogStart,file_queued_handler:fileQueued,file_queue_error_handler:fileQueueError,file_dialog_complete_handler:fileDialogComplete,upload_start_handler:uploadStart,upload_progress_handler:uploadProgress,upload_error_handler:uploadError,upload_success_handler:uploadSuccess,upload_complete_handler:uploadComplete,queue_complete_handler:queueComplete};
swfu=new SWFUpload(a);};function swfUploadLoaded(){var a=this;var b=function(){setFileHint();var d=a.customSettings.file_upload_data;var c=a.customSettings.file_urlpath+"/attach?action=query";$.beginPageLoading("loading...");$.post(c,"fileId="+d+"&ftpSite="+$("#ftpSite").val()+"&filePath="+$("#filePath").val(),function(i){if(i){var f=$.parseJSON(i);
if(f.context&&f.context.x_resultcode&&f.context.x_resultcode=="0"){var h=f.data;if(h){var g=$("#filetable");if(g){var e=0;$.each(h,function(j,l){l.index=j;l.id=l.fileId;l.name=l.fileName;l.size=l.fileSize;l.percent="100";l.oper=$.lang["view.web.comp.upload.del"];l.status=l.fileId;l.progress=" e_progress-ok";
var k=$.format.lowercase(l.fileName.substring(l.fileName.lastIndexOf("."),l.fileName.length));if(k===".xls"||k===".xlsx"){l["filetype"]="xls";}else{if(k===".doc"||k===".docx"){l["filetype"]="doc";}else{if(k===".txt"){l["filetype"]="txt";}else{if(k===".xml"){l["filetype"]="xml";}else{if(k===".gif"||k===".jpg"||k===".png"||k===".ioc"){l["filetype"]="pic";
}else{l["filetype"]="file";}}}}}e++;fileTableTemp.append(g,l);});setFileHint($.lang.get("view.web.comp.upload.uploaded",e+" "));}talbe=null;e=null;}h=null;}f=null;}$.endPageLoading();},"POST");c=null;};this.customSettings.loadingTimeout=setTimeout(function(){b.call(a);},1*500);}function fileDialogStart(){var b=$("tr",$("#filetable")[0]);
var a=this.getStats();a.successful_uploads=b.length;this.setStats(a);$("#bfinish").attr("disabled",true);$("#bclean").attr("disabled",true);}function fileQueued(b){try{addFileToTable(b);}catch(a){this.debug(a);}}function fileQueueError(b,d,c){try{switch(d){case SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT:alert($.lang.get("view.web.comp.upload.sizelimit","["+this.settings.file_size_limit+"]"));
break;case SWFUpload.QUEUE_ERROR.ZERO_BYTE_FILE:alert($.lang["view.web.comp.upload.size0"]);break;case SWFUpload.QUEUE_ERROR.INVALID_FILETYPE:alert($.lang.get("view.web.comp.upload.type",b["type"]));break;case SWFUpload.QUEUE_ERROR.QUEUE_LIMIT_EXCEEDED:alert($.lang.get("view.web.comp.upload.num","["+this.settings.file_upload_limit+"]"));
break;default:alert($.lang["view.web.comp.upload.error"]+c);break;}}catch(a){this.debug(a);}$("#bfinish").attr("disabled",false);$("#bclean").attr("disabled",false);}function fileDialogComplete(b,d,a){try{this.startUpload();}catch(c){this.debug(c);}if(b==0){$("#bfinish").attr("disabled",false);$("#bclean").attr("disabled",false);
}}function uploadStart(b){try{setFileHint(b);}catch(a){}return true;}function uploadProgress(b,e,d){try{var c=Math.ceil((e/d)*100);b["percent"]=c;b["loaded"]=e;b["total"]=d;changeFileStatus(b);}catch(a){this.debug(a);}}function uploadSuccess(d,b){var e;try{if(d){var a=d.id;e=$.parseJSON(b);$("#"+a+"Value").html(e.data.fileId);
}}catch(c){if(!e){alert(b);$("#"+a).remove();}}}function uploadError(b,d,c){try{switch(d){case SWFUpload.UPLOAD_ERROR.HTTP_ERROR:alert($.lang["view.web.comp.upload.disconnect"]);break;case SWFUpload.UPLOAD_ERROR.UPLOAD_FAILED:alert($.lang["view.web.comp.upload.fail"]+c);break;case SWFUpload.UPLOAD_ERROR.IO_ERROR:alert($.lang["view.web.comp.upload.readfail"]+c);
break;case SWFUpload.UPLOAD_ERROR.SECURITY_ERROR:alert($.lang["view.web.comp.upload.authority"]+c);break;case SWFUpload.UPLOAD_ERROR.UPLOAD_LIMIT_EXCEEDED:alert($.lang["view.web.comp.upload.content"]+"["+b["name"]+"]");break;case SWFUpload.UPLOAD_ERROR.FILE_VALIDATION_FAILED:alert($.lang["view.web.comp.upload.verify"]+"["+b.name+"]ï¼Œ"+c);
break;case SWFUpload.UPLOAD_ERROR.FILE_CANCELLED:alert($.lang.get("view.web.comp.upload.canceled","["+b.name+"]"));break;case SWFUpload.UPLOAD_ERROR.UPLOAD_STOPPED:alert($.lang.get("view.web.comp.upload.stop","["+b.name+"]"));break;default:break;}}catch(a){this.debug(a);}}function uploadComplete(a){}function queueComplete(b){var a=$("tr",$("#filetable")[0]);
setFileHint($.lang.get("view.web.comp.upload.uploaded",a.length+" "));a=null;$("#bfinish").attr("disabled",false);$("#bclean").attr("disabled",false);}function addFileToTable(a){if(a){var c=$("#filetable");var b=$.format.lowercase(a.type);if(b===".xls"||b===".xlsx"){a["filetype"]="xls";}else{if(b===".doc"||b===".docx"){a["filetype"]="doc";
}else{if(b===".txt"){a["filetype"]="txt";}else{if(b===".xml"){a["filetype"]="xml";}else{if(b===".gif"||b===".jpg"||b===".png"||b===".ioc"){a["filetype"]="pic";}else{a["filetype"]="file";}}}}}a.oper=$.lang["view.web.comp.upload.cancel"];a.status="uploading...";a.progress="";fileTableTemp.append(c,a);}}function setFileHint(b){var c=$("#fileHint");
var a="";if(parent.$.expando!=$.expando){a+="<span class='e_red'>"+$.lang["view.web.comp.upload.limit"]+"("+swfu.settings.file_size_limit+")</span>";}else{a+="<span class='e_red'>"+$.lang["view.web.comp.upload.limit"]+"(30M)</span>";}if(b){if($.isObject(b)){a+=" | <span class='e_red'>";a+=$.lang["view.web.comp.upload.uploading"];
a+="</span>";}else{if($.isString(b)){a+=" | <span class='e_red'>"+$.lang["view.web.comp.upload.status"];a+=b;a+="</span>";}}}c.html(a);}function changeFileStatus(c){if(c){var b=c.id;var a=c.percent==100;var d=$("#"+b);if(d&&d.length>0){$("#"+b+"Size",d[0]).html(c.size);$("#"+b+"Progress",d[0]).attr("class",a?"e_progress e_progress-ok":"e_progress");
$("#"+b+"Percent1",d[0]).css("width",c.percent+"%");$("#"+b+"Percent2",d[0]).html(c.percent+"%");$("#"+b+"Delete",d[0]).html(a?$.lang["view.web.comp.upload.del"]:$.lang["view.web.comp.upload.cancel"]);}}}function deleteFileFromTable(a){var b=$("#"+a);if(swfu&&b&&b.length>0){var d=$("#"+a+"Delete");if(d&&d.length>0){if(d.html()==$.lang["view.web.comp.upload.del"]){var c=$("#"+a+"Value").html();
$("#delData").val($("#delData").val()+c+",");b.remove();}else{if(d.html()==$.lang["view.web.comp.upload.cancel"]){swfu.cancelUpload(a,false);b.remove();}}setFileHint($.lang.get("view.web.comp.upload.uploaded",$("tr",$("#filetable")[0]).length+" "));}d=null;}b=null;}function destroyUpload(){if(swfu){swfu.destroy();
swfu=null;}if(fileTableTemp){fileTableTemp=null;}}function finishUploadFiles(){setReturnUploadFiles();handleData("ok");if(parent.$.closeFileUpload){parent.$.closeFileUpload();}}function cancelUploadFiles(){cleanUpload();handleData("cancel");if(parent.$.closeFileUpload){parent.$.closeFileUpload();}}function setReturnUploadFiles(){var d={};
var c=$("#filetable");var a="";var b=0;$("tr",c[0]).each(function(){var e=$("#"+$(this).attr("id")+"Value",this).html();if(e&&e!="uploading..."){a+=e+",";b++;}});if(a&&a!=""){a=a.substring(0,a.length-1);}d.fieldId=swfu.customSettings.file_field_id;d.size=b;d.fileData=a;c=null,b=null,a=null;if(parent.$.setFileUploadReturnValue){parent.$.setFileUploadReturnValue(d);
}d=null;}function cleanUploadFiles(){cleanUpload();var a=$("#afterAction").val();if(a&&$.isFunction(parent.window[a])){parent.window[a].call(parent,"clean");}}function cleanUpload(){var a=$("#filetable");$("tr",a[0]).each(function(){var b=$("#"+$(this).attr("id")+"Value").html();$("#delData").val($("#delData").val()+b+",");
$(this).remove();});setFileHint($.lang.get("view.web.comp.upload.uploaded","0 "));}function handleData(d){var e="";if(d=="ok"){if($("#fileDelete").val()=="true"){e=$("#delData").val();}else{if($("#delData").val()){var c=$("#delData").val().split(",");var a=$("#fileData").val().split(",");for(var b=0;
b<c.length;b++){if(!a.contains(c[b])){e+=c[b]+",";}}}}}else{if(d=="cancel"){var c=$("#delData").val().split(",");var a=$("#fileData").val().split(",");for(var b=0;b<c.length;b++){if(c[b]&&!a.contains(c[b])){e+=c[b]+",";}}}}if(e&&e.length>0){e=e.substring(0,e.length-1);$.post("attach?action=delete","fileId="+e,function(g){},"POST");
}var f=$("#afterAction").val();if(f&&$.isFunction(parent.window[f])){parent.window[f].call(parent,d);}}