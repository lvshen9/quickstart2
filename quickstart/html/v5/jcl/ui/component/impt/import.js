/*!
 * import component
 * http://www.wadecn.com/
 * auth:xiedx@asiainfo.com
 * Copyright 2015, WADE
 */
!function(t,e,i){"use strict";function o(t){return n&&t.touchs&&t.touchs.length?t.touchs[0].target:t.target?t.target:t.srcElement}if(t&&"undefined"==typeof t.Import){var n=(Array.prototype.splice,"undefined"!=typeof t.hasTouch?t.hasTouch:"ontouchstart"in e),l=n?"touchstart":"mousedown",r=t.os.phone||!0===t.ratioPhone,a=null,s=function(e,o){var n=this;n.el=e&&1==e.nodeType?e:i.getElementById(e),n.el&&n.el.nodeType&&(n.id=t.attr(n.el,"id"))&&(o&&t.isObject(o)&&t.extend(n,o),t.attr(n.el,"x-wade-uicomponent")||t.attr(n.el,"x-wade-uicomponent","import"),n._init(),n.constructor.call(n))};s.prototype=t.extend(new t.UIComponent,{setParams:function(e){var i=this;e&&t.isString(e)&&(i.params=e)},buildParams:function(e){var i=this,o=[];return o.push("rpcSessionId="+i.rpcSessionId),o.push("pushMode="+i.pushMode),o.push("config="+(i.configFile?i.configFile:"")),o.push("ftpSite="+(i.ftpCode?i.ftpCode:"")),o.push("filePath="+(i.filePath?i.filePath:"import")),o.push("fileId="+(i.file?i.file.fileId:"")),o.push("fileName="+(i.file?encodeURIComponent(i.file.name):"")),o.push("fileType="+(i.fileType?i.fileType:"")),o.push("model="+(i.model?i.model:"")),o.push("posX="+(i.posX?i.posX:"")),o.push("posY="+(i.posY?i.posY:"")),o.push("txtSplit="+(i.txtSplit?i.txtSplit:"")),o.push("fileSerializeId="+(i.fileSerializeId?i.fileSerializeId:"")),o.push("taskId="+(i.taskId?i.taskId:"")),o.push("serviceName="+(i.taskId?i.taskId:"")),o.push("listenerMethod="+(e||"")),t.ajax.buildSubmitData(i.cond,o.join("&")+(i.params&&t.isString(i.params)?"&"+i.params:""))},tip:function(t,e){var i=this;t!=undefined&&(i.tipEl.innerHTML=t),e!=undefined&&(i.tipEl.className=e)},show:function(){var e=this;e.adjust(),e.buttonIcoFold&&(e.buttonIcoFold.className="e_ico-fold");var i=e.floatEl.className?e.floatEl.className:"";(" "+i+" ").indexOf(" c_float-show ")<0&&(e.floatEl.className=t.trim(i+" c_float-show"));var o=e.browserButton.offsetWidth,n=e.browserButton.offsetHeight;e.swfup&&e.swfup.settings&&(e.swfup.settings.button_width!=o||e.swfup.settings.button_height!=n)&&e.swfup.setButtonDimensions(o,n)},hide:function(){var e=this;e.buttonIcoFold&&(e.buttonIcoFold.className="e_ico-unfold");var i=e.floatEl.className?e.floatEl.className:"";e.floatEl.className=t.trim((" "+i+" ").replace(/ c_float-show /gi," "))},adjust:function(){var t=this;if(!r){var e,o,n=i.body.offsetWidth,l=i.body.offsetHeight,a=t.icoMode?t.buttonIco.getBoundingClientRect():t.button.getBoundingClientRect(),s=t.icoMode?t.buttonIco.offsetWidth:t.button.offsetWidth,p=t.icoMode?t.buttonIco.offsetHeight:t.button.offsetHeight,f="buttom",d="right";t.floatEl.style.left="-99999px",t.floatEl.style.top="-99999px",t.floatEl.style.display="block",e=t.floatEl.offsetWidth,o=t.floatEl.offsetHeight,t.floatEl.style.display="",a.top+p+o>l&&(f="top"),a.left+e>n&&(d="left"),t.floatEl.style.top="top"==f?a.top-o+"px":a.top+p+"px",t.floatEl.style.left="left"==d?Math.max(a.left+s-e,0)+"px":a.left+"px"}},getDisabled:function(){return this.disabled},setDisabled:function(e){var i=this;i.disabled=!!e;var o=i.icoMode?i.buttonIco:i.button,n=o.className?o.className:"";i.disabled?(" "+n+" ").indexOf(" e_dis ")<0&&(o.className=t.trim(n+" e_dis")):(n=t.trim((" "+n+" ").replace(/ e_dis /gi," ")),o.className=n)},destroy:function(){var t=this;if(t.rpc&&(t.rpc.destroy(),t.rpc=null),t.file){for(var e in t.file)delete t.file[e];t.file=null}t.swfup&&(t.swfup.destroy(),t.swfup=null),t.transfer&&(t.transfer.destroy(),t.transfer=null),t.button=null,t.buttonIco=null,t.buttonIcoFold=null,t.buttonProg=null,t.buttonProgBar=null,t.floatEl=null,t.bgEl=null,t.fileForm=null,t.fileEl=null,t.nameEl=null,t.browserButton=null,t.importButton=null,t.progEl=null,t.progBarEl=null,t.tipEl=null,t.el=null,t.defaultTip=null},_init:function(){var e=this;e.url=t.FILE_UPLOAD_URL+(e.ftpCode?"&ftpSite="+e.ftpCode:"")+(e.filePath?"&filePath="+e.filePath:""),e.button=i.getElementById(e.id+"_button"),e.buttonIco=i.getElementById(e.id+"_button_icoimp"),e.buttonIcoFold=t(e.button).children("span.e_ico-unfold:first")[0],e.buttonProg=t(e.button).children("span.e_buttonProgress:first")[0],e.buttonProgBar=t(e.buttonProg).children("span.e_buttonBar:first")[0],e.floatEl=i.getElementById(e.id+"_float"),e.bgEl=t(e.floatEl).children("div.bg:first")[0];var o=t(e.floatEl).children("div.content:first"),n=o.children("div:first"),r=n.children("span.e_mix:first");e.fileForm=o.children("form:first")[0],e.fileEl=t(e.fileForm).children("input:first")[0],e.nameEl=r.children("input[type=text]:first")[0],e.browserButton=r.children("span.e_ico-browse:first")[0],e.importButton=r.find("span.e_ico-import:first").parent("button:first")[0],e.progEl=r.children("span.e_mixProgress:first")[0],e.progBarEl=t(e.progEl).children("span.e_mixBar:first")[0],e.tipEl=n.children("div:last")[0],o=null,n=null,r=null,e.auto||(e.importButton.style.display=""),t.attr(e.nameEl,"readOnly",!0),t(e.nameEl).focus(function(){this.blur()}),e.fileTypes&&(e.fileTypes=t.FileTransfer.fileTypes(e.fileTypes),e.fileTypes&&t.attr(e.fileEl,"accept",t.FileTransfer.mimeType(e.fileTypes))),e.fileTypeTip=e.fileTypes&&e.fileTypes.length?t.lang.get("ui.component.import.tip.support-filetypes",e.fileTypes.join(",")):"",e.templateTip=e.templateFile&&t.isString(e.templateFile)?'&nbsp;<a href="#nogo" ontap="$.FileTransfer.download(\''+e.templateFile+'\')">[<span class="e_ico-download"></span> '+t.lang.get("ui.component.import.tip.tpldownload")+"]</a>":"",e.tip(e.fileTypeTip+e.templateTip),e.rpcSessionId=t.expando+"_"+t.rand(1e6)+"_"+e.id,e.useSwfUpload=t.browser.msie&&t.browser.version<10,1==e.useSwfUpload?(t(e.browserButton).append('<span id="'+e.id+'_swfupload_holder"></span>'),e.swfup=new SWFUpload({upload_url:e.url,file_size_limit:e.fileSize,file_types:e.fileTypes&&e.fileTypes.length?(""+e.fileTypes.join(";")).replace(/\./g,"*."):null,flash_url:"v5/jcl/plugins/swfupload/swfupload.swf",flash9_url:"v5/jcl/plugins/swfupload/swfupload_fp9.swf",button_placeholder_id:e.id+"_swfupload_holder",button_width:e.browserButton.offsetWidth,button_height:e.browserButton.offsetHeight,button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,button_cursor:SWFUpload.CURSOR.HAND,file_queued_handler:function(t){e._setFile(t),e.nameEl.value=e.file.name,this.startUpload()},file_queue_error_handler:function(i,o,n){switch(o){case SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT:alert(t.lang.get("ui.component.upload.tip.invalid-filesize")+" "+(i?i.name:""));break;case SWFUpload.QUEUE_ERROR.INVALID_FILETYPE:alert(t.lang.get("ui.component.upload.tip.invalid-filetype")+" "+(i?i.name:""));break;case SWFUpload.QUEUE_ERROR.QUEUE_LIMIT_EXCEEDED:alert(t.lang.get("ui.component.upload.tip.file-num-limit",e.fileLimit))}},upload_start_handler:function(t){e._transferStart(e.file)},upload_progress_handler:function(t,i,o){e._transferProgress(i,o,e.file)},upload_success_handler:function(i,o){e._transferSuccess(t.parseJSON(o),"suc",e.file)},upload_error_handler:function(t,i,o){e._transferError(i,o,e.file)}})):e.transfer=new t.FileTransfer({context:e,url:e.url,start:e._transferStart,success:e._transferSuccess,error:e._transferError,progress:function(t,i){e._transferProgress(t.loaded,t.total,i)}}),e.disabled&&e.setDisabled(!0),t(e.icoMode?e.buttonIco:e.button).tap(function(){e.disabled||((" "+e.floatEl.className+" ").indexOf(" c_float-show ")<0?e.show():e.hide())}),t(e.bgEl).bind(l,function(){e.hide()}),t(e.browserButton).tap(function(){if(!e.disabled&&!0!==e.uploading&&!0!==e.importing){if(e.useSwfUpload){var i=swfobject.getFlashPlayerVersion();return void(i&&i.major||alert(t.lang.get("ui.component.swfobject.tip.flashplayer-not-installed")))}e.fileEl.click()}}),t(e.fileEl).bind("change",function(){if(!e.disabled&&!0!==e.uploading&&!0!==e.importing&&!e.useSwfUpload){if(e.auto&&!1===t.event.trigger("beforeAction",null,e.el))return e.fileForm&&e.fileForm.reset(),void e.hide();if(!(e.fileEl.files.length<=0)){var i=e.fileEl.files[0];e._setFile(i),e.file&&(e.nameEl.value=e.file.name,e.transfer.file=e.file,e.transfer.send(),e.uploading=!0)}}}),e.auto||t(e.importButton).tap(function(){e.disabled||!0!==e.uploading&&!0!==e.importing&&1==e.importReady&&!1!==t.event.trigger("beforeAction",null,e.el)&&e._doImport()})},_setFile:function(e){var i=this,o=e.name,n=e.size,l=!0;return i._validateFileType(o)?l&&n>i.fileSize?(l=!1,void i.tip(t.lang.get("ui.component.simpleupload.tip.invalid-filesize"),"e_red")):void(i.file={name:o,size:n,valid:l,fileObject:e}):(l=!1,void i.tip(t.lang.get("ui.component.simpleupload.tip.invalid-filetype"),"e_red"))},_validateFileType:function(e){var i=this;if(!i.fileTypes||!i.fileTypes.length)return!0;var o=t.FileTransfer.extName(e);return o&&t.isString(o)&&t.inArray(o,i.fileTypes)>-1||undefined==o},_transferStart:function(e){var i=this;i.buttonProgBar&&(i.buttonProgBar.style.width="0%"),i.progBarEl.style.width="0%",i.tip(t.lang.get("ui.component.import.tip.begin-upload",e.name),"")},_transferSuccess:function(e,i,o){var n,l,r=this,a=-1;if(!(e&&e.context&&e.data&&(l=e.data.fileId)))return a=e&&e.context?e.context.x_resultcode:"-1",n=e&&e.context?e.context.x_resultinfo:"",void r._transferError.call(r,a,n,o);r.uploading=!1,r.importReady=!0,o.fileId=r.el.value=l,o.fileObject=null,r.fileForm&&r.fileForm.reset(),r.buttonProgBar&&(r.buttonProgBar.style.width="0%"),r.progBarEl.style.width="0%",r.tip(t.lang.get("ui.component.import.tip.upload-complete")),r.auto&&r._doImport()},_transferError:function(e,i,o){var n=this;n.uploading=!1,o.fileObject=null,n.fileForm&&n.fileForm.reset(),n.tip(t.lang.get("tapestry.component.import.tip.upload-faild-info",i||"Status("+e+")"),"e_red")},_transferProgress:function(e,i,o){var n=this,l=e>0&&i>0?Math.round(e/i*100):0;l>=100&&(l=99),n.buttonProgBar&&(n.buttonProgBar.style.width=l+"%"),n.progBarEl.style.width=l+"%",n.tip(t.lang.get("ui.component.import.tip.uploading",l,o.name))},_doImport:function(){var i=this;i.fileSerializeId=null,i.tip(t.lang.get("ui.component.import.tip.begin-import",i.file.name)),t.ajaxRequest({url:t.IMPEXP_URL+"?_="+Math.random(),data:i.buildParams("refreshStatus"),type:"POST",dataType:"json",encoding:"UTF-8",timeout:3e5,success:function(o){if(i.fileSerializeId=o.fileSerializeId,i.messageServer=o.messageServer,i.messageServerType=o.messageServerType?o.messageServerType:null,!0===i.importing)if("10"==o.progress)i.tip(t.lang.get("ui.component.import.tip.import-started"));else{if(!i.fileSerializeId&&"error"==o.status)return i.importing=!1,i.buttonProgBar&&(i.buttonProgBar.style.width="0%"),i.progBarEl.style.width="0%",void i.tip(o.hint,"e_red");i.buttonProgBar&&(i.buttonProgBar.style.width=o.progress+"%"),i.progBarEl.style.width=o.progress+"%",i.tip(t.lang.get("ui.component.import.tip.importing",o.progress+"%",i.file.name))}1==i.pushMode?i.messageServer&&!i.rpc&&(i.rpc=new t.RPC({address:i.messageServer,session:"&sessionId="+i.rpcSessionId,type:i.messageServerType,message:function(e){if(e&&t.isObject(e))if("prog"!=e.STATUS){if(i.importing=!1,i.importReady=!1,"ok"==e.STATUS){i.buttonProgBar&&(i.buttonProgBar.style.width="100%"),i.progBarEl.style.width="100%";var o=e.ERROR_INFO,n=i.downUrl=e.DOWNLOAD_URL,l=t.lang.get("ui.component.import.tip.import-complete");if(/^[0-9,]+$/.test(o)){var r=o.split(",");l+=" "+t.lang.get("ui.component.import.tip.import-count",r[0],r[1])}else l=o;n&&(l+=' <a href="#nogo" ontap="$.FileTransfer.download(\''+n+'\')">[<span class="e_ico-download"></span> '+t.lang.get("ui.component.import.tip.faild-data-download")+"]</a>"),i.tip(l,"")}else"error"==e.STATUS&&(i.buttonProgBar&&(i.buttonProgBar.style.width="0%"),i.progBarEl.style.width="0%",i.tip(e.ERROR_INFO,"e_red"));t.event.trigger("afterAction",e.STATUS,i.el)}else if(e.PROG){var a=(""+e.PROG).indexOf("%")>-1?e.PROG:e.PROG+"%";i.buttonProgBar&&(i.buttonProgBar.style.width=a),i.progBarEl.style.width=a,i.tip(t.lang.get("ui.component.import.tip.importing",a,i.file.name))}}}),i.rpc.open()):i.timer=e.setInterval(function(){if(!i.fileSerializeId)return void e.clearInterval(i.timer);t.ajaxRequest({url:t.IMPEXP_URL+"?_="+Math.random(),data:i.buildParams("refreshStatus"),type:"POST",dataType:"json",encoding:"UTF-8",timeout:3e4,success:function(o){if(!o||!t.isObject(o))return void e.clearInterval(i.timer);if("100"==o.progress||"error"==o.status){if(e.clearInterval(i.timer),i.importing=!1,i.importReady=!1,"ok"==o.status){i.buttonProgBar&&(i.buttonProgBar.style.width="100%"),i.progBarEl.style.width="100%";var n=o.hint,l=i.downUrl=o.downloadUrl,r=t.lang.get("ui.component.import.tip.import-complete");if(/^[0-9,]+$/.test(n)){var a=n.split(",");r+=" "+t.lang.get("ui.component.import.tip.import-count",a[0],a[1])}else r=n;l&&(r+=' <a href="#nogo" ontap="$.FileTransfer.download(\''+l+'\')">[<span class="e_ico-download"></span> '+t.lang.get("ui.component.import.tip.faild-data-download")+"]</a>"),i.tip(r,"")}else"error"==o.status&&(i.buttonProgBar&&(i.buttonProgBar.style.width="0%"),i.progBarEl.style.width="0%",i.tip(o.hint,"e_red"));t.event.trigger("afterAction",o.status,i.el)}},error:function(o,n,l){e.clearInterval(i.timer),i.importing=!1,i.importReady=!1,i.tip(t.lang.get("ui.component.import.tip.import-faild",n),"e_red")}})},3e3)},error:function(e,o,n){i.importing=!1,i.importReady=!1,i.tip(t.lang.get("ui.component.import.tip.import-faild",o),"e_red")}}),i.importing=!0}}),t(function(){t(i.body).bind(l,function(n){n.originalEvent&&(n=n.originalEvent);var l=o(n);if(l&&l.nodeType){for(var r,p,f=0,d=l,u=!1;d&&d.nodeType&&d!=i.body&&f<50&&((r=t.attr(d,"id"))&&(p=r.substring(0,r.indexOf("_")),(t.nodeName(d,"button")||(""+d.className).indexOf("e_ico-import")>-1)&&p?u=e[p]&&e[p]instanceof s:t.nodeName(d,"div")&&(" "+d.className+" ").indexOf(" c_float ")>-1&&p&&(u=e[p]&&e[p]instanceof s)),1!=u);)d=d.parentNode,f++;a&&(!u||u&&p!=a)&&e[a].hide(),a=u?p:null}}),t(e).bind("onorientationchange"in e?"orientationchange":"resize",function(){a&&e[a]&&(e[a].hide(),a=null)})}),e.Import=t.Import=s}}(window.Wade,window,document);