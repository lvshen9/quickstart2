/*!
 * tree component
 * http://www.wadecn.com/
 * auth:xiedx@asiainfo.com
 * Copyright 2015, WADE
 */
!function(e,t,a){"use strict";if(e&&"undefined"==typeof e.Tree){var n=Array.prototype.splice,i=("undefined"!=typeof e.hasTouch&&e.hasTouch,function(t,n){var i=this;i.el=t&&1==t.nodeType?t:a.getElementById(t),i.el&&i.el.nodeType&&(i.id=e.attr(i.el,"id"))&&(n&&e.isObject(n)&&e.extend(i,n),e.attr(i.el,"x-wade-uicomponent")||e.attr(i.el,"x-wade-uicomponent","tree"),i._init(),i.constructor.call(i))});i.prototype=e.extend(new e.UIComponent,{setParam:function(e,t){var a=this;a.params||(a.params={}),a.params[e]=t},getCheckedNodeIds:function(t){var a=this;if(a.isShowCheckBox){var n=[];if(e("input[name="+a.checkBoxName+"]:checked",a.el).each(function(){n.push(e.attr(this.parentNode.parentNode,"id"))}),n.length>1&&t){n.sort(function(e,t){return e.lastIndexOf("●")-t.lastIndexOf("●")});for(var i,d,o=n.length-1;o>-1;o--)(i=a._getDataIdByNodeId(n[o]))&&(d=a.getParentNodeDataByDataId(i))&&e.inArray(treeId+"○"+d.dataid,n)>-1&&n.splice(o,1)}return n}},init:function(){var t=this;if(t.data)t.draw(),t.expandPath&&t.expandByPath(t.expandPath);else{if(!(t.clazz||t.method||t.listener||t.componentId))return void MessageBox.error(e.lang.get("ui.component.tree.tip.msg-title"),e.lang.get("ui.component.tree.tip.invalid-parameter",t.id));e(t.el).append('<span id="'+t.id+'_loading" class="e_ico-loading"></span>');var a=function(a){e("#"+t.id+"_loading").remove();var n=a.context;if("0"!=n.x_resultcode)return void MessageBox.error(e.lang.get("ui.component.tree.tip.msg-title"),n.x_resultinfo);t.data=a.data,t.draw(),t.expandPath&&t.expandByPath(t.expandPath),e.event.trigger("afterAction",null,t.el)},n=t._buildParams();t.clazz&&t.method?e.httphandler.post(t.clazz,t.method,n,a,null,{dataType:"json",simple:!0}):e.ajax.post(t.page?t.page:null,t.listener,n,t.componentId?t.componentId:null,a,null,{dataType:"json",simple:!0})}},append:function(t,a,n,i,d){var o=this,l=e.isPlainObject(t);if(undefined!=t&&null!=t&&(l||undefined!=a&&null!=a)){l&&undefined==d&&(d=a,a=null);var r;if(!d||(r=o._getNodeDataByDataId(d))){var s=e.extend({showcheck:"false",haschild:"false",complete:"false",expand:"false",groupid:null,href:null,checked:"false",disabled:"false"},l?t:{id:t,text:a,value:n,showcheck:i?"true":"false"});if(s.dataid=r?r.dataid+"●"+s.id:s.id,r){if(r.childNodes||(r.childNodes={}),"true"!=r.haschild&&(r.haschild="true"),"undefined"!=typeof r.childNodes[s.id])return;r.childNodes[s.id]=s}else{if(o.data||(o.data={}),"undefined"!=typeof o.data[s.id])return;o.data[s.id]=s}var c=o._buildNode(s);if(r){var u=e("#"+o.id+"○"+d),p=u.children("ul:first"),h=""+u.attr("className");(" "+h+" ").indexOf(" leaf ")>-1&&(h=e.trim((" "+h+" ").replace(/ leaf /g," unfold ")),u.attr("className",h)),p&&p.length?p.append(c):u.append("<ul>\n"+c+"</ul>\n"),u=p=null}else{var p=e(o.el).children("ul:first");p&&p.length?p.append(c):e(o.el).html("<ul>\n"+c+"</ul>\n"),p=null}c=null}}},remove:function(t){var a=this;if(t&&e.isString(t)){var n=a._getNodeDataByDataId(t);if(n){var i=n.id,d=a._getParentNodeDataByDataId(t);if(d){if(delete d.childNodes[i],e.isEmptyObject(d.childNodes)){d.haschild="false";var o=e("#"+a.id+"○"+d.dataid);o.children("ul:first");"leaf"!=o.attr("className")&&o.attr("className","leaf"),o=null}}else delete a.data[i];e("#"+a.id+"○"+t).remove(),n=null}}},empty:function(){var t=this;if(t.data){e(t.el).empty();var a=function(e){for(var t in e)"childNodes"==t&&a(e[t]),delete e[t]};a(t.data),delete t.data,t.data=null,t.lastActiveTapNodeId=null,t.lastExpandNodeId=null,t.lastCheckedNodeId=null,e.browser.msie&&CollectGarbage()}},draw:function(){var t=this;if(t.data){var a=[];a.push("<ul>\n");var n=[];for(var i in t.data)t.data[i]&&e.isObject(t.data[i])&&n.push([i,t.data[i].order]);n.sort(function(e,t){return parseInt(e[1])-parseInt(t[1])});for(var d=0;d<n.length;d++)a.push(t._buildNode(t.data[n[d][0]])),n.splice(d--,1);n=null,a.push("</ul>\n"),e(t.el).html(a.join(""))}},expand:function(t){var n=this,i=n._getNodeDataByNodeId(t);if(i){var d="true"==""+i.haschild,o="true"==""+i.complete;if(!1!==e.event.trigger("expandAction",i,n.el)){if(d&&!o){if(n.isAsync&&n.asyncLoading)return void MessageBox.alert(e.lang.get("ui.component.tree.tip.msg-title"),e.lang.get("ui.component.tree.tip.node-loading-uncompleted"));if(n.isAsync&&!i.childNodes){var l=n._buildParams();l+="&Tree_Parent_NodeID="+encodeURIComponent(i.id),l+="&Tree_Parent_DataID="+encodeURIComponent(i.dataid),l+="&Tree_Parent_GroupID="+(null!=i.groupid&&i.groupid!=undefined?encodeURIComponent(i.groupid):""),l+="&Tree_Parent_isChecked="+encodeURIComponent(i.checked),n.asyncLoading=!0;var r=function(a){n.asyncLoading=!1,e("#"+t+"_loading").remove();var d=a.context;return"0"!=d.x_resultcode?(n.queue.length=[],void MessageBox.error(e.lang.get("ui.component.tree.tip.msg-title"),d.x_resultinfo)):a.data&&e.isObject(a.data)?(i.childNodes=a.data,void n.expand(t)):void 0};return e("#"+t+" div[class=text]").prepend('<span id="'+t+'_loading" class="e_ico-loading"></span>'),void(n.clazz&&n.method?e.httphandler.post(n.clazz,n.method,l,r,null,{dataType:"json",simple:!0}):(n.listener||n.componentId)&&e.ajax.post(n.page?n.page:null,n.listener,l,n.componentId?n.componentId:null,r,null,{dataType:"json",simple:!0}))}var s=[],c=i.childNodes;if(c&&e.isObject(c)){var u=[];for(var p in c)c[p]&&e.isObject(c[p])&&u.push([p,c[p].order]);u.sort(function(e,t){return parseInt(e[1])-parseInt(t[1])});for(var h=0;h<u.length;h++)s.push(n._buildNode(c[u[h][0]])),u.splice(h--,1);u=null,e("#"+t+" ul:first").html(s.join("")),s=null,i.complete="true"}else MessageBox.alert(e.lang.get("ui.component.tree.tip.msg-title"),e.lang.get("ui.component.tree.tip.childnode-no-data"))}if(d){var f=a.getElementById(t);if(f&&1==f.nodeType){var g=f.className?f.className:"";(" "+g+" ").indexOf(" leaf ")<0&&(f.className=e.trim((" "+g+" ").replace(/ fold /gi," "))+" unfold")}f=null,n._autoRefreshScroller()}n.queue.splice(e.inArray(t,n.queue),1)}}},expandQueue:function(){var e=this;e.queue.length?(e.asyncLoading||e.expand(e.queue[0]),e.timer=setTimeout("window['"+e.id+"'].expandQueue();",500)):e.timer&&clearTimeout(e.timer)},expandByPath:function(t,a,n){var i=this;if(e.isFunction(a)&&(n=a,a=null),!t||!e.isString(t))return void MessageBox.alert(e.lang.get("ui.component.tree.tip.msg-title"),e.lang.get("ui.component.tree.tip.invalid-expandpath"));a&&e.isString(a)||(a="-"),e.isFunction(n)&&(i.expandByPathCallback=n);for(var d,o=t.split(a),l=[],r=0;r<o.length;r++)l.push(o[r]),d=i.id+"○"+l.join("●"),r==o.length-1&&(i.lastExpandNodeId=d),i.isAsync?i.queue.push(d):i.expand(d);o=l=null,i.isAsync&&i.expandQueue()},collapse:function(t){var n=this,i=a.getElementById(t);if(i&&1==i.nodeType){var d=i.className?i.className:"";(" "+d+" ").indexOf(" leaf ")<0&&(i.className=e.trim((" "+d+" ").replace(/ unfold /gi," "))+" fold")}i=null,n._autoRefreshScroller()},destroy:function(){var t=this;if(t.data)for(var a in t.data)delete t.data[a];if(t.data=null,e.isObject(t.params)){for(var i in t.params)delete t.params[i];t.params=null}for(var d=0;d<t.queue.length;d++)n.call(t.queue,d--,1);t.queue=null,t.el=null},_init:function(){var t=this;this.queue=[],e(t.el).tap(function(a){a.originalEvent&&(a=e.event.fix(a.originalEvent));var n=a.target;if(n&&1!=!n.nodeType){var i,d,o,l,r=n.className?n.className:"";if(e.nodeName(n,"input")&&e.attr(n,"type")==t.checkBoxType&&(i=n.parentNode)&&(i=i.parentNode)&&1==i.nodeType&&e.nodeName(i,"li")&&(d=e.attr(i,"id"))){if(t._activeNode(d),!1===e.event.trigger("checkBoxAction",t._getNodeDataByNodeId(d),t.el))return n.checked=!n.checked,void(i=r=null);t._checkNode(d,n.checked)}else if(e.nodeName(n,"div")&&(i=n.parentNode)&&1==i.nodeType&&e.nodeName(i,"li")&&(d=e.attr(i,"id")))if(l=i.className?i.className:"",o=(" "+l+" ").indexOf(" unfold ")>-1,t._activeNode(d),(" "+r+" ").indexOf(" text ")>-1){if(!1===e.event.trigger("textAction",t._getNodeDataByNodeId(d),t.el))return void(i=r=l=null);var s=!1;if(t.isShowCheckBox){for(var c=0,u=n.previousSibling,p=!1;c<3&&u;){if(1==u.nodeType&&e.nodeName(u,"div")&&(" "+u.className+" ").indexOf(" checkbox ")>-1){p=!0;break}u=u.previousSibling,c++}if(!0===p){var h=u.getElementsByTagName("input")[0];if(h&&1==h.nodeType&&e.attr(h,"type")==t.checkBoxType){if(s=!0,!1===e.event.trigger("checkBoxAction",t._getNodeDataByNodeId(d),t.el))return void(i=r=l=null);t._checkNode(d,!h.checked,!1)}}}s||t._triggerNode(d,o)}else(" "+r+" ").indexOf(" ico ")>-1&&t._triggerNode(d,o);i=r=l=null}})},_autoRefreshScroller:function(){for(var n,i=this,d=i.el.parentNode,o=0;o<50&&d&&d.nodeType&&d!=a.body;)1==d.nodeType&&"scroller"==e.attr(d,"x-wade-uicomponent")&&(n=e.attr(d,"id"))&&t[n]&&t[n]instanceof e.Scroller&&t[n].refresh(),d=d.parentNode,o++;d=null},_getDataIdByNodeId:function(t){if(t&&e.isString(t)){var a=t.lastIndexOf("○");return t.substring(a+1,t.length)}},_getNodeDataByDataId:function(t){var a=this;if(t&&e.isString(t)&&a.data&&e.isObject(a.data)){var n,i=t.split("●");if(i&&i.length)for(var n,d,o=0;o<i.length&&(0==o?n=a.data[i[o]]:n&&(d=n.childNodes)&&e.isObject(d)&&(n=d[i[o]]),n);o++);return i=null,n}},_getParentNodeDataByDataId:function(t){var a=this;if(t&&e.isString(t)){var n,i=t.split("●");return i&&i.length>=2&&(i.splice(i.length-1,1),n=a._getNodeDataByDataId(i.join("●"))),i=null,n}},_getNodeDataByNodeId:function(t){var a=this;if(t&&e.isString(t)){var n=t.lastIndexOf("○"),i=t.substring(n+1,t.length);return a._getNodeDataByDataId(i)}},_buildParams:function(){var t=this,a=[];if(a.push("Tree_ID="+encodeURIComponent(t.id)),a.push("Tree_IsShowCheckBox="+t.isShowCheckBox),a.push("Tree_IsSearch="+t.isSearch),a.push("Tree_IsFolder="+t.isFolder),a.push("Tree_IsAsync="+t.isAsync),t.checkBoxName&&a.push("Tree_CheckBoxName="+encodeURIComponent(t.checkBoxName)),t.checkBoxType&&a.push("Tree_CheckBoxType="+encodeURIComponent(t.checkBoxType)),t.iconDir&&a.push("Tree_IconDir="+encodeURIComponent(t.iconDir)),!e.isEmptyObject(t.params))for(var n in t.params)a.push(encodeURIComponent(n)+"="+encodeURIComponent(t.params[n]));return a.join("&")},_buildNode:function(t){var a=this;if(t&&e.isObject(t)){var n=[],i=t.dataid,d=a.id+"○"+i,o="true"==""+t.haschild,l=(t.complete,t.href,o?"fold":"leaf");return n.push('<li id="'+d+'" class="'+l+'">\n'),n.push('<div class="ico"></div>\n'),"true"==t.showcheck&&(n.push('<div class="checkbox">'),n.push('<input name="'+a.checkBoxName+'" type="'+("radio"==a.checkBoxType?"radio":"checkbox")+'" value="'+t.value+'" '+("true"==""+t.checked?"checked":"")+" "+("true"==""+t.disabled?"disabled":"")+" />"),n.push("</div>\n")),n.push('<div class="text" title="'+t.text+'" >'+t.text+"</div>\n"),o&&n.push("<ul></ul>"),n.push("</li>\n"),n.join("")}},_triggerNode:function(e,t){var a=this;e&&(t?a.collapse(e):a.expand(e))},_checkNode:function(t,a,n){var i=this;if(i.isShowCheckBox){var d=i._getNodeDataByNodeId(t);if(d){if("radio"==i.checkBoxType)d.checked="true",i.lastCheckedNodeId&&t!=i.lastCheckedNodeId&&(d=i._getNodeDataByNodeId(i.lastCheckedNodeId))&&(d.checked="false",0==n&&e("#"+i.lastCheckedNodeId+" input[type=radio]:first").attr("checked",!!a)),0==n&&t!=i.lastCheckedNodeId&&e("#"+t+" input[type=radio]:first").attr("checked",!!a);else if("checkbox"==i.checkBoxType&&(d.checked=a?"true":"false",0==n&&e("#"+t+" input[type=checkbox]:first").attr("checked",!!a),"true"==d.haschild)){var o=d.childNodes;if(o&&e.isObject(o)){var l;for(var r in o)l=o[r],e.isObject(l)&&i._checkNode(i.id+"○"+l.dataid,a,!1)}}i.lastCheckedNodeId=t}}},_activeNode:function(t){var n,i,d=this;t&&e.isString(t)&&t!=d.lastActiveTapNodeId&&(n=a.getElementById(t),i=d.lastActiveTapNodeId?a.getElementById(d.lastActiveTapNodeId):null,i&&1==i.nodeType&&(i.className=e.trim((" "+i.className+" ").replace(/ on /gi," "))),n&&1==n.nodeType&&(n.className=e.trim((n.className?n.className:"")+" on"),d.lastActiveTapNodeId=t)),n=i=null}}),t.Tree=e.Tree=i}}(Wade,window,document);