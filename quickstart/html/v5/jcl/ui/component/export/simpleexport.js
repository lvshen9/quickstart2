/*!
 * simple export component
 * http://www.wadecn.com/
 * auth:xiedx@asiainfo.com
 * Copyright 2015, WADE
 */
!function(e,t,i){"use strict";if(e&&"undefined"==typeof e.Export){var n=(Array.prototype.splice,function(t,n){var r=this;r.el=t&&1==t.nodeType?t:i.getElementById(t),r.el&&r.el.nodeType&&(r.id=e.attr(r.el,"id"))&&(n&&e.isObject(n)&&e.extend(r,n),e.attr(r.el,"x-wade-uicomponent")||e.attr(r.el,"x-wade-uicomponent","simpleexport"),r._init(),r.constructor.call(r))});n.prototype=e.extend(new e.UIComponent,{setParams:function(t){var i=this;t&&e.isString(t)&&(i.params=t)},buildParams:function(t){var i=this,n=[];return n.push("rpcSessionId="+i.rpcSessionId),n.push("pushMode="+i.pushMode),n.push("config="+(i.configFile?i.configFile:"")),n.push("ftpSite="+(i.ftpCode?i.ftpCode:"")),n.push("filePath="+(i.filePath?i.filePath:"export")),n.push("fileId="+(i.file?i.file.fileId:"")),n.push("fileType="+(i.fileType?i.fileType:"")),n.push("model="+(i.model?i.model:"")),n.push("posX="+(i.posX?i.posX:"")),n.push("posY="+(i.posY?i.posY:"")),n.push("fileSerializeId="+(i.fileSerializeId?i.fileSerializeId:"")),n.push("taskId="+(i.taskId?i.taskId:"")),n.push("serviceName="+(i.taskId?i.taskId:"")),n.push("listenerMethod="+(t||"")),n.push("fileName="+encodeURIComponent(i.fullFileName)),e.ajax.buildSubmitData(i.cond,n.join("&")+(i.params&&e.isString(i.params)?"&"+i.params:""))},tip:function(e,t){var i=this;e!=undefined&&(i.el.value=e),t!=undefined&&(i.el.className="e_left "+t)},getDisabled:function(){return this.disabled},setDisabled:function(t){var i=this;i.disabled=!!t;var n=i.span.className?i.span.className:"";i.disabled?((" "+n+" ").indexOf(" e_dis ")<0&&(i.span.className=e.trim(n+" e_dis")),i.el.disabled=!0):(n=e.trim((" "+n+" ").replace(/ e_dis /gi," ")),i.span.className=n,i.el.disabled=!1)},destroy:function(){var e=this;e.rpc&&(e.rpc.destroy(),e.rpc=null),e.span=null,e.btnReset=null,e.btnDownload=null,e.btnExport=null,e.progEl=null,e.progBarEl=null,e.el=null},_init:function(){var i=this;i.span=e(i.el).parent("span.e_mix:first"),i.btnReset=e(i.span).find("span.e_ico-reset:first").parent("button")[0],i.btnDownload=e(i.span).children("span.e_ico-download:first")[0],i.btnExport=e(i.span).find("span.e_ico-export:first").parent("button")[0],i.progEl=e(i.span).children("span.e_mixProgress:first")[0],i.progBarEl=e(i.progEl).children("span.e_mixBar:first")[0],e.attr(i.btnDownload,"tip",e.lang.get("ui.component.simpleexport.tip.export-file-download")),i.fileTypes&&(i.fileTypes=e.FileTransfer.fileTypes(i.fileTypes)),i.rpcSessionId=e.expando+"_"+e.rand(1e6)+"_"+i.id,e(i.btnReset).tap(function(){i.disabaled||!0===i.exporting||(e.attr(i.el,"readOnly",null),i.btnReset.style.display="none",i.btnDownload.style.display="none",i.btnExport.style.display="",i.progBarEl.style.width="0%",i.el.value=i.fileName?i.fileName:"",i.tip(i.defaultTip,"e_black-light"))}),e(i.btnDownload).tap(function(){i.disabaled||!0===i.exporting||i.downUrl&&t.open(i.downUrl+"&_="+Math.random(),"_new_download_win","height=40,width=100,top=0,left=0,toolbar=no,menubar=no,scrollbars=no, resizable=no,location=no, status=no")}),e(i.btnExport).tap(function(){if(!i.disabaled&&!0!==i.exporting){var n=i.fileName=i.el.value;if(n&&e.trim(n)){var r=e("#"+i.id+"_filetype_sel").val();if(i.fileTypes&&e.inArray(r,i.fileTypes)<0)return void i.tip(e.lang.get("ui.component.simpleexport.tip.invalid-filename"),"e_red");i.fullFileName=n+r,!1!==e.event.trigger("beforeAction",null,i.el)&&(i.fileSerializeId=null,e.attr(i.el,"readOnly",!0),i.tip(e.lang.get("ui.component.simpleexport.tip.begin-export",n)),e.ajaxRequest({url:e.IMPEXP_URL+"?_="+Math.random(),data:i.buildParams("refreshStatus"),type:"POST",dataType:"json",encoding:"UTF-8",timeout:3e4,success:function(r){if(i.fileSerializeId=r.fileSerializeId,i.messageServer=r.messageServer,i.messageServerType=r.messageServerType?r.messageServerType:null,!0===i.exporting)if("10"==r.progress)i.tip(e.lang.get("ui.component.simpleexport.tip.export-started"));else{if(!i.fileSerializeId&&"error"==r.status)return i.exporting=!1,i.progBarEl.style.width="0%",void i.tip(r.hint,"e_red");i.progBarEl.style.width=r.progress+"%",i.tip(e.lang.get("ui.component.simpleexport.tip.exporting",r.progress,n))}1==i.pushMode?i.messageServer&&!i.rpc&&(i.rpc=new e.RPC({address:i.messageServer,type:i.messageServerType,session:"&sessionId="+i.rpcSessionId,message:function(t){if(t&&e.isObject(t))if("prog"!=t.STATUS){if(i.exporting=!1,i.btnReset.style.display="",i.btnExport.style.display="none","ok"==t.STATUS){i.progBarEl.style.width="100%";var n=i.downUrl=t.DOWNLOAD_URL;n&&(i.btnDownload.style.display=""),i.tip(e.lang.get("ui.component.simpleexport.tip.export-complete"),"e_black-light")}else"error"==t.STATUS&&(i.progBarEl.style.width="0%",i.tip(t.ERROR_INFO,"e_red"));e.event.trigger("afterAction",t.STATUS,i.el)}else if(t.PROG){var r=(""+t.PROG).indexOf("%")>-1?t.PROG:t.PROG+"%";i.progBarEl.style.width=r,i.tip(e.lang.get("ui.component.simpleexport.tip.exporting",r,i.fileName))}}}),i.rpc.open()):i.timer=t.setInterval(function(){if(!i.fileSerializeId)return void t.clearInterval(i.timer);e.ajaxRequest({url:e.IMPEXP_URL+"?_="+Math.random(),data:i.buildParams("refreshStatus"),type:"POST",dataType:"json",encoding:"UTF-8",timeout:3e4,success:function(n){if(!n||!e.isObject(n))return void t.clearInterval(i.timer);if("100"==n.progress||"error"==n.status){if(t.clearInterval(i.timer),i.exporting=!1,i.btnReset.style.display="",i.btnExport.style.display="none","ok"==n.status){i.progBarEl.style.width="100%";(i.downUrl=n.downloadUrl)&&(i.btnDownload.style.display=""),i.tip(e.lang.get("ui.component.simpleexport.tip.export-complete"),"e_black-light")}else"error"==n.status&&(i.progBarEl.style.width="0%",i.tip(n.hint,"e_red"));e.event.trigger("afterAction",n.status,i.el)}},error:function(n,r,l){t.clearInterval(i.timer),i.exporting=!1,i.btnReset.style.display="",i.btnExport.style.display="none",i.tip(e.lang.get("ui.component.simpleexport.tip.export-faild",r),"e_red")}})},3e3)},error:function(t,n,r){i.exporting=!1,i.btnReset.style.display="",i.btnExport.style.display="none",i.tip(e.lang.get("ui.component.simpleexport.tip.export-faild",n),"e_red")}}),i.exporting=!0)}}})}}),t.SimpleExport=e.SimpleExport=n}}(window.Wade,window,document);